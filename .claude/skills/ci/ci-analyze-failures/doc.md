---
name: ci-analyze-failures
description: "CI の失敗ログを解析し、原因を特定するCI/CDパイプラインでテストやビルドが失敗した場合に使用します。CI/CDパイプラインでテストやビルドが失敗した場合に使用します。"
allowed-tools: ["Read", "Grep", "Bash"]
metadata:
  skillport:
    category: ci
    tags: [ci-cd, debugging, analysis]
    alwaysApply: false
---

# CI Analyze Failures

CI/CD パイプラインの失敗を分析し、原因を特定するスキル。
GitHub Actions、GitLab CI 等のログを解釈します。

---

## 入力

- **CI ログ**: 失敗したジョブのログ
- **run_id**: CI 実行の識別子（あれば）
- **リポジトリコンテキスト**: CI 設定ファイル

---

## 出力

- **失敗原因の特定**: 具体的な原因
- **修正提案**: 対処方法の提案

---

## 実行手順

### Step 1: CI 状態の確認

```bash
# GitHub Actions の場合
gh run list --limit 5

# 最新の失敗を確認
gh run view --log-failed
```

### Step 2: 失敗ログの取得

```bash
# 特定の run のログ
gh run view {{run_id}} --log

# 失敗ステップのみ
gh run view {{run_id}} --log-failed
```

### Step 3: エラーパターンの分析

#### ビルドエラー

```
パターン: "error TS\d+:" または "Build failed"
原因候補:
- TypeScript 型エラー
- 依存関係の不足
- 構文エラー
```

#### テストエラー

```
パターン: "FAIL" または "✕" または "AssertionError"
原因候補:
- テストの失敗
- テストタイムアウト
- モックの不一致
```

#### 依存関係エラー

```
パターン: "npm ERR!" または "Could not resolve"
原因候補:
- package.json の不整合
- プライベートパッケージの認証
- バージョン競合
```

#### 環境エラー

```
パターン: "not found" または "undefined"
原因候補:
- 環境変数の未設定
- シークレットの不足
- パスの問題
```

### Step 4: 分析結果の出力

```markdown
## 🔍 CI 失敗分析

**Run ID**: {{run_id}}
**失敗時刻**: {{timestamp}}
**失敗ステップ**: {{step_name}}

### 原因特定

**エラータイプ**: {{ビルド / テスト / 依存関係 / 環境}}

**エラーメッセージ**:
```
{{エラーの核心部分}}
```

**原因分析**:
{{具体的な原因の説明}}

### 関連ファイル

| ファイル | 関連性 |
|---------|-------|
| `{{path}}` | {{関連内容}} |

### 修正提案

1. {{具体的な修正手順1}}
2. {{具体的な修正手順2}}

### 自動修正の可否

- 自動修正: {{可能 / 不可能}}
- 理由: {{理由}}
```

---

## エラーパターン辞書

### TypeScript エラー

| エラーコード | 意味 | 典型的な修正 |
|-------------|------|-------------|
| TS2304 | 名前が見つからない | import 追加 |
| TS2322 | 型が一致しない | 型修正 |
| TS2345 | 引数の型が違う | 引数修正 |
| TS7006 | 暗黙の any | 型注釈追加 |

### npm エラー

| エラー | 意味 | 典型的な修正 |
|--------|------|-------------|
| ERESOLVE | 依存関係解決失敗 | package-lock 削除 & 再インストール |
| ENOENT | ファイルが見つからない | パス確認 |
| EACCES | 権限エラー | CI 設定確認 |

### Jest/Vitest エラー

| エラー | 意味 | 典型的な修正 |
|--------|------|-------------|
| Timeout | テストタイムアウト | タイムアウト延長 or 非同期修正 |
| Snapshot | スナップショット不一致 | `npm test -- -u` |

---

## 複数エラーの優先順位

1. **ビルドエラー**: 最優先で修正
2. **依存関係エラー**: ビルド前に解決必要
3. **テストエラー**: ビルド成功後に対応
4. **Lint エラー**: 最後に対応

---

## 次のアクションへの接続

分析完了後：

> 📊 **分析完了**
>
> **原因**: {{原因の要約}}
>
> **次のアクション**:
> - 「修正して」→ 自動修正を試行
> - 「詳しく」→ さらに詳細な分析
> - 「スキップ」→ 手動対応に切り替え

---

## 注意事項

- **ログは大きい**: 重要部分を抽出
- **連鎖エラー注意**: 最初のエラーを見つける
- **環境差異**: ローカルと CI の違いを考慮
